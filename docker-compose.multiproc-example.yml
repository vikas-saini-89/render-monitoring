version: '3.8'

# Example to show how to configure a shared multiprocess dir for prometheus_client
# Mount this volume into both web and celery services so counters/histograms are aggregated

services:
  web:
    image: your-web-image
    environment:
      - PROMETHEUS_MULTIPROC_DIR=/var/prometheus-multiproc
      # Optionally set a start command via START_CMD e.g. START_CMD="gunicorn app:app"
      - START_CMD=${START_CMD:-}
    volumes:
      - prometheus_multiproc:/var/prometheus-multiproc
      - ./scripts:/scripts:ro
    entrypoint: ["/bin/sh","-c","/scripts/clean_multiproc_dir.sh && exec ${START_CMD:-sh -c 'echo \"Replace START_CMD with your app start command\"; sleep infinity'}"]

  celery:
    image: your-celery-image
    environment:
      - PROMETHEUS_MULTIPROC_DIR=/var/prometheus-multiproc
      - CELERY_CMD=${CELERY_CMD:-}
    volumes:
      - prometheus_multiproc:/var/prometheus-multiproc
      - ./scripts:/scripts:ro
    entrypoint: ["/bin/sh","-c","/scripts/clean_multiproc_dir.sh && exec ${CELERY_CMD:-sh -c 'echo \"Replace CELERY_CMD with your celery start command\"; sleep infinity'}"]

volumes:
  prometheus_multiproc:
    driver: local
