name: CI

on:
  pull_request:
    paths:
      - '**/*.yml'
      - '**/*.yaml'
      - '**/*.json'
      - 'docker-compose.yml'
      - 'prometheus.yml'
      - 'alertmanager.yml'
  push:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          pip install yamllint
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Run yamllint
        run: |
          yamllint -c .github/configs/yamllint.yaml prometheus.yml alertmanager.yml docker-compose.yml || (echo 'Yamllint failed' && exit 1)

      - name: Validate Dashboard JSON
        run: |
          for f in dashboards/*.json; do
            echo "Checking $f"
            jq empty "$f" || { echo "Invalid JSON: $f"; exit 1; }
          done

      - name: Prometheus config lint (promtool)
        run: |
          docker run --rm -v "${{ github.workspace }}":/work -w /work prom/prometheus:v2.48.0 promtool check config /work/prometheus.yml

      - name: Low-memory profile check
        run: |
          ./scripts/ci/lowmem-check.sh .env.lowmem.example

      - name: Run quick validation
        run: |
          ./validate.sh
